@page
@model CDM.InventorySystem.Pages.Items.CheckOutModel
@{
    ViewData["Title"] = "Check Out Item";
}

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">Check Out Item</h4>
                </div>
                <div class="card-body">
                    <div class="row g-3 align-items-start">
                        <div class="col-lg-7">
                            <button type="button" class="btn btn-outline-primary mb-3" id="startScanner">
                                Start Camera Scanner
                            </button>
                            <button type="button" class="btn btn-outline-secondary mb-3" id="stopScanner" style="display: none;">
                                Stop Scanner
                            </button>
                            <div id="scannerContainer" style="display: none;">
                                <div id="barcodeScanner" style="width:100%;max-width:500px;height:300px; margin:auto; border:2px solid #007bff; border-radius:8px;"></div>
                                <div class="text-center mt-2">
                                    <small class="text-muted">Point camera at barcode. Scanning will start automatically.</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-5">
                            <label for="barcodeInput" class="form-label">Or Enter Barcode Manually</label>
                            <div class="input-group mb-3">
                                <input type="text" class="form-control form-control-lg" id="barcodeInput"
                                       placeholder="Enter barcode ID (e.g., CDM-KB-001)" autocomplete="off" />
                                <button type="button" class="btn btn-primary input-group-text" onclick="lookupItem()">
                                    Lookup Item
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- ... rest of your logic/tables/forms unchanged ... -->
                    <div id="alertContainer"></div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <script>
        let scannerActive = false;
        document.getElementById('startScanner').addEventListener('click', startScanner);
        document.getElementById('stopScanner').addEventListener('click', stopScanner);
        document.getElementById('barcodeInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') { e.preventDefault(); lookupItem(); }
        });
        function startScanner() {
            const scannerContainer = document.getElementById('scannerContainer');
            const startBtn = document.getElementById('startScanner');
            const stopBtn = document.getElementById('stopScanner');
            scannerContainer.style.display = 'block';
            startBtn.style.display = 'none';
            stopBtn.style.display = 'inline-block';
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#barcodeScanner'),
                    constraints: { width: 500, height: 300, facingMode: "environment" }
                },
                decoder: { readers: ["code_128_reader", "ean_reader", "upc_reader"] }
            }, function(err) {
                if (err) {
                    showAlert('Camera Error: ' + err.name + ' - ' + err.message + '<br><br>' +
                        'Please check camera permission or HTTPS.', 'danger');
                    stopScanner();
                    return;
                }
                Quagga.start();
                scannerActive = true;
            });
            Quagga.onDetected(function(result) {
                if (scannerActive) {
                    const code = result.codeResult.code;
                    document.getElementById('barcodeInput').value = code;
                    lookupItem();
                    stopScanner();
                }
            });
        }
        function stopScanner() {
            if (scannerActive) {
                Quagga.stop();
                scannerActive = false;
            }
            const scannerContainer = document.getElementById('scannerContainer');
            const startBtn = document.getElementById('startScanner');
            const stopBtn = document.getElementById('stopScanner');
            scannerContainer.style.display = 'none';
            startBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
        }
        async function lookupItem() {
            const barcode = document.getElementById('barcodeInput').value.trim();
            if (!barcode) {
                showAlert('Please enter a barcode', 'warning');
                return;
            }
            try {
                const response = await fetch(`/api/items/barcode/${encodeURIComponent(barcode)}`);
                if (response.ok) {
                    const item = await response.json();
                    displayItemDetails(item);
                } else {
                    showAlert('Item not found. Please check the barcode.', 'danger');
                }
            } catch (error) {
                showAlert('Error looking up item', 'danger');
            }
        }
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alert);
            setTimeout(() => { alert.remove(); }, 5000);
        }
    </script>
}
0